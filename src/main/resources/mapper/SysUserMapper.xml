<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lanf.system.mapper.SysUserMapper">
    <resultMap id="SysUserMap" type="com.lanf.model.system.SysUser" autoMapping="true">
    </resultMap>

    <!-- 用于select查询公用抽取的列 -->
    <sql id="columns">
        u.id, u.username, u.password, u.name, u.phone as mobile, u.head_url, u.dept_id, u.description, u.email,
u.status, u.create_time, u.update_time, u.is_deleted, d.roleIds, sdept.name as dept_name
    </sql>

    <select id="selectPage" resultMap="SysUserMap">
        select
        <include refid="columns"/>
        from sys_user u
        left join (
        select
        STUFF(
        (
        select ',' + CAST(sd.id AS VARCHAR(MAX))
        from sys_role sd
        inner join sys_user_role sud on sd.id = sud.role_id
        where sd.is_deleted = 0 and sud.is_deleted = 0 and sud.user_id = su.user_id
        for xml path('')
        ), 1, 1, ''
        ) as roleIds,
        su.user_id
        from sys_user_role su
        group by su.user_id
        ) d on u.id = d.user_id
        left join (
        select * from sys_dept where is_deleted = 0
        ) sdept on u.dept_id = sdept.id
        <where>
            <if test="vo.keyword != null and vo.keyword != ''">
                and (
                u.username like '%' + #{vo.keyword} + '%'
                or u.name like '%' + #{vo.keyword} + '%'
                or u.phone like '%' + #{vo.keyword} + '%'
                )
            </if>
            <if test="vo.createTimeBegin != null and vo.createTimeBegin != ''">
                and u.create_time &gt;= #{vo.createTimeBegin}
            </if>
            <if test="vo.createTimeEnd != null and vo.createTimeEnd != ''">
                and u.create_time &lt;= #{vo.createTimeEnd}
            </if>
            <choose>
                <when test="vo.deptId != null and vo.deptId != ''">
                    and exists (
                    select 1
                    from sys_dept xd
                    where xd.id = u.dept_id
                    and xd.is_deleted = 0
                    and xd.tree_path like '%,' + #{vo.deptId} + ',%'
                    )
                </when>
            </choose>
            and u.is_deleted = 0
        </where>
        order by u.create_time desc
    </select>

</mapper>
